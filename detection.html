<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detection & Upload - Illegal Deforestation Tracker</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
        }
        .header {
            background: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            margin: 0;
            color: #333;
        }
        .nav-buttons {
            display: flex;
            gap: 1rem;
        }
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            color: white;
            font-weight: 500;
        }
        .btn-primary { background: #667eea; }
        .btn-success { background: #28a745; }
        .btn-info { background: #17a2b8; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn:hover { opacity: 0.8; }
        .main-content {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        .upload-section {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .upload-section h2 {
            margin: 0 0 1.5rem 0;
            color: #333;
        }
        .upload-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        .upload-option {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        .upload-option.active {
            border-color: #667eea;
            background: #f8f9ff;
        }
        .upload-option h3 {
            margin: 0 0 1rem 0;
            color: #333;
        }
        .upload-option p {
            margin: 0;
            color: #666;
        }
        .file-input {
            display: none;
        }
        .file-info {
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 5px;
            display: none;
        }
        .file-info.show {
            display: block;
        }
        .detection-params {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .param-group {
            margin-bottom: 1.5rem;
        }
        .param-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
        }
        .param-group input, .param-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        .param-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .results-section {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
        }
        .results-section.show {
            display: block;
        }
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .results-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
        }
        .stat-card h3 {
            margin: 0 0 0.5rem 0;
            color: #667eea;
            font-size: 2rem;
        }
        .stat-card p {
            margin: 0;
            color: #666;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 1rem 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }
        .loading {
            text-align: center;
            padding: 2rem;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç Detection & Upload</h1>
        <div class="nav-buttons">
            <a href="auth.html" class="btn btn-primary">Login</a>
            <a href="map.html" class="btn btn-success">Map</a>
            <a href="incidents.html" class="btn btn-info">Incidents</a>
            <a href="assistant.html" class="btn btn-warning">Assistant</a>
        </div>
    </div>

    <div class="main-content">
        <div class="upload-section">
            <h2>üì§ Upload Satellite Data</h2>
            <div class="upload-options">
                <div class="upload-option" onclick="selectUploadType('file')">
                    <h3>üìÅ Upload Files</h3>
                    <p>Upload your own satellite imagery files</p>
                    <input type="file" id="fileInput" class="file-input" multiple accept=".tif,.tiff,.png,.jpg,.jpeg">
                </div>
                <div class="upload-option" onclick="selectUploadType('synthetic')">
                    <h3>üß™ Generate Synthetic Data</h3>
                    <p>Create synthetic satellite data for testing</p>
                </div>
            </div>
            
            <div id="fileInfo" class="file-info">
                <h4>Selected Files:</h4>
                <div id="fileList"></div>
            </div>
        </div>

        <div class="detection-params">
            <h2>‚öôÔ∏è Detection Parameters</h2>
            <div class="param-row">
                <div class="param-group">
                    <label for="lossThreshold">Loss Threshold:</label>
                    <input type="number" id="lossThreshold" value="0.25" min="0" max="1" step="0.01">
                </div>
                <div class="param-group">
                    <label for="tileSize">Tile Size:</label>
                    <select id="tileSize">
                        <option value="32">32x32</option>
                        <option value="64" selected>64x64</option>
                        <option value="128">128x128</option>
                    </select>
                </div>
            </div>
            <div class="param-row">
                <div class="param-group">
                    <label for="bboxMinLat">Min Latitude:</label>
                    <input type="number" id="bboxMinLat" value="10.0" step="0.001">
                </div>
                <div class="param-group">
                    <label for="bboxMaxLat">Max Latitude:</label>
                    <input type="number" id="bboxMaxLat" value="30.0" step="0.001">
                </div>
            </div>
            <div class="param-row">
                <div class="param-group">
                    <label for="bboxMinLng">Min Longitude:</label>
                    <input type="number" id="bboxMinLng" value="70.0" step="0.001">
                </div>
                <div class="param-group">
                    <label for="bboxMaxLng">Max Longitude:</label>
                    <input type="number" id="bboxMaxLng" value="90.0" step="0.001">
                </div>
            </div>
            <button onclick="startDetection()" class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1.1rem;">üöÄ Start Detection</button>
        </div>

        <div id="loadingSection" class="loading" style="display: none;">
            <div class="spinner"></div>
            <h3>Processing Data...</h3>
            <p>Please wait while we analyze your satellite imagery.</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <div id="resultsSection" class="results-section">
            <div class="results-header">
                <h2>üìä Detection Results</h2>
                <button onclick="viewOnMap()" class="btn btn-success">View on Map</button>
            </div>
            
            <div class="results-stats">
                <div class="stat-card">
                    <h3 id="totalIncidents">0</h3>
                    <p>Incidents Detected</p>
                </div>
                <div class="stat-card">
                    <h3 id="highSeverity">0</h3>
                    <p>High Severity</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalArea">0</h3>
                    <p>Total Area (sq km)</p>
                </div>
                <div class="stat-card">
                    <h3 id="confidence">0%</h3>
                    <p>Confidence</p>
                </div>
            </div>

            <div id="incidentsList">
                <!-- Incidents will be populated here -->
            </div>
        </div>
    </div>

    <script>
        let selectedFiles = [];
        let uploadType = null;
        let detectionResults = null;

        // Select upload type
        function selectUploadType(type) {
            uploadType = type;
            document.querySelectorAll('.upload-option').forEach(option => {
                option.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            if (type === 'file') {
                document.getElementById('fileInput').click();
            }
        }

        // Handle file selection
        document.getElementById('fileInput').addEventListener('change', function(e) {
            selectedFiles = Array.from(e.target.files);
            displaySelectedFiles();
        });

        // Display selected files
        function displaySelectedFiles() {
            const fileInfo = document.getElementById('fileInfo');
            const fileList = document.getElementById('fileList');
            
            if (selectedFiles.length > 0) {
                fileInfo.classList.add('show');
                fileList.innerHTML = selectedFiles.map(file => `
                    <div style="padding: 0.5rem; background: white; margin: 0.5rem 0; border-radius: 5px; border: 1px solid #ddd;">
                        <strong>${file.name}</strong> (${(file.size / 1024 / 1024).toFixed(2)} MB)
                    </div>
                `).join('');
            } else {
                fileInfo.classList.remove('show');
            }
        }

        // Start detection process
        async function startDetection() {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('Please login first');
                window.location.href = 'auth.html';
                return;
            }

            // Show loading
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('resultsSection').classList.remove('show');
            
            // Simulate progress
            simulateProgress();

            try {
                if (uploadType === 'synthetic') {
                    await generateSyntheticData();
                } else {
                    await processUploadedFiles();
                }
            } catch (error) {
                console.error('Detection error:', error);
                alert('Detection failed: ' + error.message);
            } finally {
                document.getElementById('loadingSection').style.display = 'none';
            }
        }

        // Generate synthetic data
        async function generateSyntheticData() {
            const token = localStorage.getItem('token');
            
            const response = await fetch('http://127.0.0.1:8001/api/synth-tiles', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    n: parseInt(document.getElementById('tileSize').value),
                    drop: parseFloat(document.getElementById('lossThreshold').value)
                })
            });

            if (response.ok) {
                const data = await response.json();
                await runDetection(data.tiles[0], data.tiles[1]);
            } else {
                throw new Error('Failed to generate synthetic data');
            }
        }

        // Process uploaded files
        async function processUploadedFiles() {
            if (selectedFiles.length < 2) {
                throw new Error('Please select at least 2 files for comparison');
            }

            // Simulate file processing
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // For demo purposes, generate synthetic data
            await generateSyntheticData();
        }

        // Run detection
        async function runDetection(t0Id, t1Id) {
            const token = localStorage.getItem('token');
            
            const response = await fetch('http://127.0.0.1:8001/api/detect', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    t0_id: t0Id,
                    t1_id: t1Id,
                    loss_threshold: parseFloat(document.getElementById('lossThreshold').value)
                })
            });

            if (response.ok) {
                detectionResults = await response.json();
                displayResults();
            } else {
                throw new Error('Detection failed');
            }
        }

        // Display results
        function displayResults() {
            const results = detectionResults;
            
            document.getElementById('totalIncidents').textContent = results.n_cases || 0;
            document.getElementById('highSeverity').textContent = results.incidents ? 
                results.incidents.filter(i => i.severity > 30).length : 0;
            document.getElementById('totalArea').textContent = results.incidents ? 
                (results.incidents.reduce((sum, i) => sum + (i.cells ? i.cells.length : 0), 0) * 0.01).toFixed(2) : 0;
            document.getElementById('confidence').textContent = '85%';

            // Display incidents list
            const incidentsList = document.getElementById('incidentsList');
            if (results.incidents && results.incidents.length > 0) {
                incidentsList.innerHTML = `
                    <h3>Detected Incidents:</h3>
                    <div style="display: grid; gap: 1rem;">
                        ${results.incidents.map(incident => `
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 5px; border-left: 4px solid #667eea;">
                                <h4 style="margin: 0 0 0.5rem 0;">${incident.case_id}</h4>
                                <p style="margin: 0; color: #666;">
                                    Severity: ${incident.severity} | 
                                    Location: ${incident.centroid[0].toFixed(4)}, ${incident.centroid[1].toFixed(4)} |
                                    Cells: ${incident.cells ? incident.cells.length : 0}
                                </p>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                incidentsList.innerHTML = '<p>No incidents detected in this area.</p>';
            }

            document.getElementById('resultsSection').classList.add('show');
        }

        // Simulate progress
        function simulateProgress() {
            const progressFill = document.getElementById('progressFill');
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 100) progress = 100;
                progressFill.style.width = progress + '%';
                
                if (progress >= 100) {
                    clearInterval(interval);
                }
            }, 200);
        }

        // View results on map
        function viewOnMap() {
            if (detectionResults && detectionResults.incidents) {
                const incidentIds = detectionResults.incidents.map(i => i.case_id).join(',');
                window.location.href = `map.html?incidents=${incidentIds}`;
            } else {
                window.location.href = 'map.html';
            }
        }

        // Initialize
        window.onload = function() {
            // Check authentication
            if (!localStorage.getItem('token')) {
                window.location.href = 'auth.html';
            }
        };
    </script>
</body>
</html>
